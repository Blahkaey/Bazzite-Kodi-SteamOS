#!/bin/sh
#
# Kodi standalone startup script
#

APP="/usr/lib64/kodi/kodi-gbm"

# Start PulseAudio if needed
if command -v start-pulseaudio-x11 >/dev/null 2>&1; then
    if ! pgrep -x pulseaudio >/dev/null 2>&1; then
        start-pulseaudio-x11 2>/dev/null || true
    fi
fi

LOOP=1
CRASHCOUNT=0
LASTSUCCESSFULSTART=$(date +%s)

while [ $LOOP -eq 1 ]
do
    $APP "$@"
    RET=$?
    NOW=$(date +%s)

    if [ $RET -ge 64 ] && [ $RET -le 66 ] || [ $RET -eq 0 ]; then
        LOOP=0
    else
        DIFF=$((NOW-LASTSUCCESSFULSTART))
        if [ $DIFF -gt 60 ]; then
            LASTSUCCESSFULSTART=$NOW
            CRASHCOUNT=0
        else
            CRASHCOUNT=$((CRASHCOUNT+1))
            if [ $CRASHCOUNT -ge 3 ]; then
                LOOP=0
                echo "Kodi crashed 3 times in ${DIFF} seconds. Giving up." >&2
            fi
        fi
    fi
done