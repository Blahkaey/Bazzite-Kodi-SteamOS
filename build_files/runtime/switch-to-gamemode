#!/bin/bash
set -euo pipefail

echo "Switching to Gaming Mode..."

# Stop Kodi service
systemctl stop kodi-gbm.service 2>/dev/null || true

# Give service time to stop cleanly
sleep 2

# Get the primary user
PRIMARY_USER=$(awk -F: '$3 >= 1000 && $3 < 65534 {print $1; exit}' /etc/passwd)

if [ -z "$PRIMARY_USER" ]; then
    echo "ERROR: Could not determine primary user" >&2
    exit 1
fi

# Restore autologin configuration for gamescope
cat > /etc/sddm.conf.d/zz-steamos-autologin.conf << EOF
[Autologin]
Session=gamescope-session.desktop
User=${PRIMARY_USER}
EOF

# Start SDDM which will auto-login to gamescope session
if ! systemctl start sddm.service; then
    echo "ERROR: Failed to start SDDM service" >&2
    exit 1
fi

echo "Switched to Gaming Mode successfully"s
