#!/bin/bash
set -euo pipefail

echo "HDR Kodi + Gaming Mode First Boot Setup"
echo "========================================"

# Get primary user
PRIMARY_USER=$(awk -F: '$3 >= 1000 && $3 < 65534 {print $1; exit}' /etc/passwd)

if [ -n "$PRIMARY_USER" ]; then
    echo "Setting up permissions for user: $PRIMARY_USER"
    usermod -a -G render,video,input "$PRIMARY_USER" 2>/dev/null || true
fi

# Ensure kodi user has proper permissions
if id kodi >/dev/null 2>&1; then
    echo "Configuring kodi user permissions..."
    chown -R kodi:kodi /var/lib/kodi/.kodi/ 2>/dev/null || true
fi

# Set default to gaming mode
echo "Setting default session to Gaming Mode..."
/usr/bin/switch-to-gamemode

echo ""
echo "Setup complete!"
echo ""
echo "Quick Reference:"
echo "  session-switcher kodi    - Switch to Kodi HDR"
echo "  session-switcher gaming  - Switch to Gaming Mode"
echo "  session-switcher status  - Check current session"
echo ""
echo "Kodi HDR Features:"
echo "  - GBM backend for direct hardware access"
echo "  - GLES rendering for HDR passthrough"
echo "  - Optimized for HDR content playback"
echo ""

# Check if user needs to re-login
if [ -n "$PRIMARY_USER" ] && [ "$PRIMARY_USER" = "$USER" ]; then
    if ! groups | grep -q "render\|video\|input"; then
        echo "NOTE: You may need to log out and back in for group changes to take effect."
    fi
fi
