#!/bin/bash
#
# Kodi pre-launch script - runs as root to set DRM properties
#

# Function: Find the active HDMI connector
find_active_hdmi_connector() {
    local connector
    for connector in /sys/class/drm/card*-HDMI-*/status; do
        if [ -f "$connector" ] && [ "$(cat "$connector")" = "connected" ]; then
            echo "${connector%/status}"
            return 0
        fi
    done
    return 1
}

# Function: Set DRM content type property
set_drm_content_type() {
    local content_type=$1
    local active_connector

    # Find the active HDMI connector
    if ! active_connector=$(find_active_hdmi_connector); then
        echo "[KODI-PRELAUNCH] No active HDMI connector found" >&2
        return 1
    fi

    # Extract connector name
    local connector_name=$(basename "$active_connector" | sed 's/card[0-9]*-//')

    echo "[KODI-PRELAUNCH] Setting content_type to $content_type on connector $connector_name"

    if command -v modetest >/dev/null 2>&1; then
        # Get full modetest output
        local modetest_output=$(modetest -c 2>/dev/null)

        # Find the connector ID for our HDMI connector
        local connector_id=$(echo "$modetest_output" | grep -E "^[0-9]+.*connected.*$connector_name" | awk '{print $1}')

        if [ -n "$connector_id" ]; then
            echo "[KODI-PRELAUNCH] Found connector ID: $connector_id for $connector_name"

            # Set the property using the property name
            if modetest -w "${connector_id}:content type:${content_type}" 2>/dev/null; then
                echo "[KODI-PRELAUNCH] Content type set successfully to $content_type (Cinema mode - ALLM disabled)"
                return 0
            else
                echo "[KODI-PRELAUNCH] Failed to set content_type via modetest" >&2
            fi
        else
            echo "[KODI-PRELAUNCH] Could not find connector ID for $connector_name" >&2
        fi
    else
        echo "[KODI-PRELAUNCH] modetest not found" >&2
    fi

    return 1
}

echo "[KODI-PRELAUNCH] Running pre-launch setup.."
echo "[KODI-PRELAUNCH] $(date)"

# Set content type to Cinema (2) to disable ALLM
# This runs as root before kodi takes DRM master
for attempt in 1 2 3; do
    echo "[KODI-PRELAUNCH] Attempt $attempt of 3"
    if set_drm_content_type 3; then
        echo "[KODI-PRELAUNCH] Successfully disabled ALLM/Game Mode"
        exit 0
    fi
    [ $attempt -lt 3 ] && sleep 0.5
done

echo "[KODI-PRELAUNCH] WARNING: Could not disable ALLM/Game Mode after 3 attempts"
# Exit 0 anyway - don't prevent Kodi from starting
exit 0